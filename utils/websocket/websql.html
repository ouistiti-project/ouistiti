<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<!--script type="text/javascript" language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script-->
		<script type="text/javascript" language="javascript" src="js/jquery.min.js"></script>
		<script language="javascript" type="text/javascript">
class JsonRPC
{
	constructor(method)
	{
		this.jsonrpc = "2.0";
		this.method = method;
		this.params = new Object();
	}
	generateid()
	{
		var array = new Uint32Array(1);
		window.crypto.getRandomValues(array);
		return array[0];
	}
	append(key, value)
	{
		this.params[key] = value;
	}
	stringify()
	{
		this.id = this.generateid();
		return JSON.stringify(this);
	}
	parse(text)
	{
		var result = JSON.parse(text);
		if (this.id && this.id != result.id)
			return "Bad response ID";
		if (result.result)
			this.result = result.result;
		else
			return "Error: " + result.error.code + " " + result.error.message;
		return this;
	}
};

var websocket;
var rpc;
function writeToScreen(message)
{
	$("#output").append("<p>"+message+"</p>");
}

function connect()
{
	$("#output").html("<div id=\"output\"></div>");
	$("#wsUri").prop("readonly", true);
	$("#input").prop("readonly", false);
	websocket = new WebSocket($("#wsUri").val());
	websocket.onopen = function(evt) { onOpen(evt) };
	websocket.onclose = function(evt) { onClose(evt) };
	websocket.onmessage = function(evt) { onMessage(evt) };
	websocket.onerror = function(evt) { onError(evt) };
}

function disconnect()
{
	websocket.close();
}

function onOpen(evt)
{
	writeToScreen("CONNECTED");
}
function onClose(evt)
{
	$("#wsUri").prop("readonly", false);
	$("#input").prop("readonly", true);
	writeToScreen("DISCONNECTED");
}

function onMessage(evt)
{
	rpc.parse(evt.data);
	if (rpc.error != undefined)
		writeToScreen('<span style="color: red;">ERROR:</span> ' + rpc.error.message);
	else
	{
		var i;
		writeToScreen('<span style="color: blue;">RESPONSE: ');
		for (i = 0; i < rpc.result.length; i++)
		{
			var result = rpc.result[i];
			var resultstring = "";
			for (var property in result)
			{
				 resultstring += property + "(" + result[property] + ")| ";
			}
			writeToScreen(resultstring);
		}
	}
}

function onError(evt)
{
	writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
	websocket.close();
}

$(document).ready(function() {
	$("#connect").on("click", connect);
	$("#disconnect").on("click", disconnect);
	$("#input").prop("readonly", true);
	$("#input").on("keypress", function(e)
		{
			if (!e) {
				e = window.event;
			}
			var keyCode = e.keyCode || e.which;
			if (keyCode == '13'){
				rpc = new JsonRPC("exec");
				rpc.append("query", $(this).val());
				var rpcstring = rpc.stringify();
				alert("rpcstring "+rpcstring.length);
				websocket.send(rpcstring);
			}
		});
});

		</script>
	</head>
	<body>
		<title>WebSocket Test</title>
		<xmp>
create table groups("group");
create table users("name","passwd","group" INTEGER);
insert into groups values("root");
insert into groups values("users");
insert into users values("root","?",(select ROWID from groups where "group"="root"));
insert into users values("test","foobar",(select ROWID from groups where "group"="users"));
select name, passwd,groups."group" from users,groups where users."group"=groups.ROWID;
		</xmp>
		<form>
			<input type="text" id="wsUri" value="ws://127.0.0.1/jsonrpc" />
			<input type="button" id="connect" value="Connect" />
			<input type="button" id="disconnect" value="Disconnect" />
			<input type="text" id="input" />
		</form>
		<h2>WebSocket Test</h2>

		<div id="output"></div>
	</body>
</html>
